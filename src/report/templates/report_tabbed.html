{% extends "base.html" %}

{% block title %}{{ repo_info.repo_name }} - MetricMancer Report{% endblock %}

{%- macro render_tree(directory, prefix="") -%}
  {#- Combine and sort directories and files into a single list -#}
  {%- set items = (directory.scan_dirs.values()|sort(attribute='dir_name')) + (directory.files.values()|sort(attribute='name')) -%}

  {%- for item in items -%}
    {%- set is_last = loop.last -%}
    {%- set connector = "└── " if is_last else "├── " -%}
    {%- set new_prefix = prefix + ("    " if is_last else "│   ") -%}

    {%- if item.dir_name is defined -%} {# It's a directory (ScanDir) #}
      <div class="tree-item is-folder">
        <div class="tree-line">
          <span class="prefix">{{ prefix }}{{ connector }}</span>
          <span class="toggle">▶</span>
          <span class="name">{{ item.dir_name }}/</span>
          <span class="kpis">[Avg C: {{ item.kpis.complexity.value | round(1) if item.kpis.get('complexity') else '?' }}, Avg Cog: {{ item.kpis.cognitive_complexity.value | round(1) if item.kpis.get('cognitive_complexity') and item.kpis.cognitive_complexity.value is not none else '?' }}, Avg Churn: {{ item.kpis.churn.value if item.kpis.get('churn') else '?' }}, Avg Hotspot: {{ item.kpis.hotspot.value | round(1) if item.kpis.get('hotspot') else '?' }}]</span>
        </div><div class="nested">{{- render_tree(item, new_prefix) -}}</div>
      </div>
    {%- else -%} {# It's a file #}
      <div class="tree-item is-file">
      <div class="tree-line"><span class="prefix">{{ prefix }}{{ connector }}</span><span class="name">{{ item.name }}</span> <span class="kpis">[C: {{ item.kpis.complexity.value | round(1) if item.kpis.get('complexity') else '?' }}, Cog: {{ item.kpis.cognitive_complexity.value | round(1) if item.kpis.get('cognitive_complexity') and item.kpis.cognitive_complexity.value is not none else '?' }}, Churn: {{ item.kpis.churn.value if item.kpis.get('churn') else '?' }}, Hotspot: {{ item.kpis.hotspot.value | round(1) if item.kpis.get('hotspot') else '?' }}]</span></div>
      </div>
    {%- endif -%}
  {%- endfor -%}
{%- endmacro -%}

{% block content %}
  {# Tab Navigation #}
  <div class="tabs">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="tree">File Tree</button>
    <button class="tab-btn" data-tab="quickwins">Quick Wins</button>
  </div>

  {# Tab Content: Overview #}
  <div id="tab-overview" class="tab-content active">
    <h2>Overview - {{ repo_info.repo_name }}</h2>
    <div class="overview-stats">
      <p><strong>Repository:</strong> {{ repo_info.repo_name }}</p>
      {% if repo_info.kpis.get('complexity') %}
      <p><strong>Average Complexity:</strong> {{ repo_info.kpis.complexity.value | round(1) }}</p>
      {% endif %}
      {% if repo_info.kpis.get('cognitive_complexity') %}
      <p><strong>Average Cognitive Complexity:</strong> {{ repo_info.kpis.cognitive_complexity.value | round(1) }}</p>
      {% endif %}
      {% if repo_info.kpis.get('churn') %}
      <p><strong>Average Churn:</strong> {{ repo_info.kpis.churn.value | round(1) }}</p>
      {% endif %}
    </div>
  </div>

  {# Tab Content: File Tree #}
  <div id="tab-tree" class="tab-content">
    <div class="file-tree-container">
      <h2>File & KPI Tree for {{ repo_info.repo_name }}</h2>
      <div class="tree-controls">
        <button id="expand-all-btn">Expand All</button>
        <button id="collapse-all-btn">Collapse All</button>
      </div>
      <p>Klicka på mapparna (▶) för att expandera/kollapsa.</p>
      <div class="tree">
        {{ render_tree(repo_info) }}
      </div>
    </div>
  </div>

  {# Tab Content: Quick Wins #}
  <div id="tab-quickwins" class="tab-content">
    <h2>Quick Wins</h2>
    <p>Quick wins analysis will be displayed here.</p>
    <p><em>Integration coming soon...</em></p>
  </div>
{% endblock %}

{% block scripts %}
<style>
  /* Tab styles */
  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
  }
  .tab-btn {
    padding: 10px 20px;
    border: none;
    background-color: #f2f2f2;
    cursor: pointer;
    border-radius: 5px 5px 0 0;
    font-size: 14px;
    transition: background-color 0.2s;
  }
  .tab-btn:hover {
    background-color: #e0e0e0;
  }
  .tab-btn.active {
    background-color: #007bff;
    color: white;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .overview-stats {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-top: 10px;
  }
  .overview-stats p {
    margin: 10px 0;
  }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');

                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Deactivate all tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Show selected tab content
                document.getElementById('tab-' + tabName).classList.add('active');
                button.classList.add('active');
            });
        });

        // Tree functionality
        document.querySelectorAll('.tree-item.is-folder .toggle').forEach(toggle => {
            const parentItem = toggle.closest('.tree-item');
            if (parentItem) {
                toggle.addEventListener('click', () => parentItem.classList.toggle('is-open'));
            }
        });

        const allFolders = document.querySelectorAll('.tree-item.is-folder');

        const expandBtn = document.getElementById('expand-all-btn');
        const collapseBtn = document.getElementById('collapse-all-btn');

        if (expandBtn) {
            expandBtn.addEventListener('click', () => {
                allFolders.forEach(folder => {
                    folder.classList.add('is-open');
                });
            });
        }

        if (collapseBtn) {
            collapseBtn.addEventListener('click', () => {
                allFolders.forEach(folder => {
                    folder.classList.remove('is-open');
                });
            });
        }
    });
</script>
{% endblock %}
