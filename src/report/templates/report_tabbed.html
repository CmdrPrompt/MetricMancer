{% extends "base.html" %}

{% block title %}{{ repo_info.repo_name }} - MetricMancer Report{% endblock %}

{% macro render_tree(directory, prefix="") %}
  {#- Combine and sort directories and files into a single list -#}
  {% set items = (directory.scan_dirs.values()|sort(attribute='dir_name')) + (directory.files.values()|sort(attribute='name')) %}

  {% for item in items %}
    {% set is_last = loop.last %}
    {% set connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ " %}
    {% set new_prefix = prefix + ("    " if is_last else "â”‚   ") %}

    {% if item.dir_name is defined %} {# It's a directory (ScanDir) #}
      <div class="tree-item is-folder">
        <div class="tree-line">
          <span class="prefix">{{ prefix|safe }}{{ connector }}</span>
          <span class="toggle">â–¶</span>
          <span class="name">{{ item.dir_name }}/</span>
          <span class="kpis">[Avg C: {{ item.kpis.complexity.value | round(1) if item.kpis.get('complexity') else '?' }}, Avg Cog: {{ item.kpis.cognitive_complexity.value | round(1) if item.kpis.get('cognitive_complexity') and item.kpis.cognitive_complexity.value is not none else '?' }}, Avg Churn: {{ item.kpis.churn.value if item.kpis.get('churn') else '?' }}, Avg Hotspot: {{ item.kpis.hotspot.value | round(1) if item.kpis.get('hotspot') else '?' }}]</span>
        </div><div class="nested">{{ render_tree(item, new_prefix) }}</div>
      </div>
    {% else %} {# It's a file #}
      <div class="tree-item is-file">
      <div class="tree-line"><span class="prefix">{{ prefix|safe }}{{ connector }}</span><span class="name">{{ item.name }}</span> <span class="kpis">[C: {{ item.kpis.complexity.value | round(1) if item.kpis.get('complexity') else '?' }}, Cog: {{ item.kpis.cognitive_complexity.value | round(1) if item.kpis.get('cognitive_complexity') and item.kpis.cognitive_complexity.value is not none else '?' }}, Churn: {{ item.kpis.churn.value if item.kpis.get('churn') else '?' }}, Hotspot: {{ item.kpis.hotspot.value | round(1) if item.kpis.get('hotspot') else '?' }}]</span></div>
      </div>
    {% endif %}
  {% endfor %}
{% endmacro %}

{% block content %}
  {# Tab Navigation #}
  <div class="tabs">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="tree">File Tree</button>
    <button class="tab-btn" data-tab="quickwins">Quick Wins</button>
  </div>

  {# Tab Content: Overview #}
  <div id="tab-overview" class="tab-content active">
    <h2>Overview - {{ repo_info.repo_name }}</h2>
    <div class="overview-stats">
      <p><strong>Repository:</strong> {{ repo_info.repo_name }}</p>
      {% if repo_info.kpis.get('complexity') %}
      <p><strong>Average Complexity:</strong> {{ repo_info.kpis.complexity.value | round(1) }}</p>
      {% endif %}
      {% if repo_info.kpis.get('cognitive_complexity') %}
      <p><strong>Average Cognitive Complexity:</strong> {{ repo_info.kpis.cognitive_complexity.value | round(1) }}</p>
      {% endif %}
      {% if repo_info.kpis.get('churn') %}
      <p><strong>Average Churn:</strong> {{ repo_info.kpis.churn.value | round(1) }}</p>
      {% endif %}
    </div>
  </div>

  {# Tab Content: File Tree #}
  <div id="tab-tree" class="tab-content">
    <div class="file-tree-container">
      <h2>File & KPI Tree for {{ repo_info.repo_name }}</h2>
      <div class="tree-controls">
        <button id="expand-all-btn">Expand All</button>
        <button id="collapse-all-btn">Collapse All</button>
      </div>
      <p>Klicka pÃ¥ mapparna (â–¶) fÃ¶r att expandera/kollapsa.</p>
      <div class="tree">
        {# Show root directory #}
        <div class="tree-item is-folder">
          <div class="tree-line">
            <span class="prefix">â””â”€â”€ </span>
            <span class="toggle">â–¶</span>
            <span class="name">{{ repo_info.dir_name }}/</span>
            <span class="kpis">[Avg C: {{ repo_info.kpis.complexity.value | round(1) if repo_info.kpis.get('complexity') else '?' }}, Avg Cog: {{ repo_info.kpis.cognitive_complexity.value | round(1) if repo_info.kpis.get('cognitive_complexity') and repo_info.kpis.cognitive_complexity.value is not none else '?' }}, Avg Churn: {{ repo_info.kpis.churn.value if repo_info.kpis.get('churn') else '?' }}, Avg Hotspot: {{ repo_info.kpis.hotspot.value | round(1) if repo_info.kpis.get('hotspot') else '?' }}]</span>
          </div>
          <div class="nested">{{ render_tree(repo_info, "       ") }}</div>
        </div>
      </div>
    </div>
  </div>

  {# Tab Content: Quick Wins #}
  <div id="tab-quickwins" class="tab-content">
    <h2>Quick Wins - Highest Impact, Lowest Effort</h2>
    {% if quick_wins and quick_wins|length > 0 %}
      <div class="quick-wins-summary">
        <p><strong>Total Opportunities:</strong> {{ quick_wins|length }}</p>
        <p><strong>Best ROI:</strong> {{ quick_wins[0].file_path }} (Impact: {{ quick_wins[0].impact }}/10, Effort: {{ quick_wins[0].effort }}/10)</p>
        <p class="tip">ðŸ’¡ Start with items 1-3 for maximum return on investment</p>
      </div>

      <div class="quick-wins-list">
        {% for win in quick_wins[:10] %}
        <div class="quick-win-item">
          <div class="quick-win-header">
            <h3>{{ loop.index }}. {{ win.action_type }}: {{ win.file_path }}</h3>
          </div>
          <div class="quick-win-metrics">
            <div class="metric-row">
              <span class="metric-label">Impact:</span>
              <div class="metric-bar-container">
                <div class="metric-bar impact-bar" style="width: {{ (win.impact / 10 * 100)|int }}%"></div>
              </div>
              <span class="metric-value">
                {% if win.impact >= 7 %}High{% elif win.impact >= 5 %}Medium{% else %}Low{% endif %} ({{ win.impact }}/10)
              </span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Effort:</span>
              <div class="metric-bar-container">
                <div class="metric-bar effort-bar" style="width: {{ (win.effort / 10 * 100)|int }}%"></div>
              </div>
              <span class="metric-value">
                {% if win.effort >= 7 %}High{% elif win.effort >= 4 %}Medium{% else %}Low{% endif %} ({{ win.effort }}/10)
              </span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Time:</span>
              <span class="metric-text">{{ win.time_estimate }}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Metrics:</span>
              <span class="metric-text">
                {% if win.complexity > 0 %}Complexity: {{ win.complexity }}{% endif %}
                {% if win.cognitive_complexity > 0 %}{% if win.complexity > 0 %}, {% endif %}Cognitive: {{ win.cognitive_complexity }}{% endif %}
                {% if win.churn > 0 %}{% if win.complexity > 0 or win.cognitive_complexity > 0 %}, {% endif %}Churn: {{ win.churn }}{% endif %}
              </span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Reason:</span>
              <span class="metric-text">{{ win.reason }}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Action:</span>
              <span class="metric-text">{{ win.action_desc }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
        {% if quick_wins|length > 10 %}
        <p class="more-opportunities">ðŸ’¡ {{ quick_wins|length - 10 }} more opportunities available. Download JSON report for full list.</p>
        {% endif %}
      </div>
    {% else %}
      <div class="no-quick-wins">
        <p>âœ… No significant improvement opportunities found!</p>
        <p>Your codebase is in good shape.</p>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
<style>
  /* Tab styles */
  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
  }
  .tab-btn {
    padding: 10px 20px;
    border: none;
    background-color: #f2f2f2;
    cursor: pointer;
    border-radius: 5px 5px 0 0;
    font-size: 14px;
    transition: background-color 0.2s;
  }
  .tab-btn:hover {
    background-color: #e0e0e0;
  }
  .tab-btn.active {
    background-color: #007bff;
    color: white;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .overview-stats {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    margin-top: 10px;
  }
  .overview-stats p {
    margin: 10px 0;
  }

  /* Quick Wins styles */
  .quick-wins-summary {
    background-color: #f0f8ff;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
  }
  .quick-wins-summary p {
    margin: 8px 0;
  }
  .quick-wins-summary .tip {
    color: #0066cc;
    font-style: italic;
    margin-top: 12px;
  }
  .quick-wins-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .quick-win-item {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s;
  }
  .quick-win-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .quick-win-header h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 16px;
    font-weight: 600;
  }
  .quick-win-metrics {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .metric-row {
    display: grid;
    grid-template-columns: 100px 1fr auto;
    gap: 15px;
    align-items: center;
  }
  .metric-label {
    font-weight: 600;
    color: #555;
    font-size: 14px;
  }
  .metric-bar-container {
    height: 24px;
    background-color: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }
  .metric-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  .impact-bar {
    background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
  }
  .effort-bar {
    background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
  }
  .metric-value {
    min-width: 120px;
    font-size: 14px;
    color: #666;
  }
  .metric-text {
    grid-column: 2 / 4;
    color: #444;
    font-size: 14px;
    line-height: 1.5;
  }
  .more-opportunities {
    text-align: center;
    color: #0066cc;
    font-style: italic;
    margin-top: 20px;
    padding: 15px;
    background-color: #f0f8ff;
    border-radius: 8px;
  }
  .no-quick-wins {
    text-align: center;
    padding: 40px 20px;
    background-color: #f0fff4;
    border-radius: 8px;
    border: 2px solid #28a745;
  }
  .no-quick-wins p {
    margin: 10px 0;
    font-size: 16px;
  }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');

                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Deactivate all tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Show selected tab content
                document.getElementById('tab-' + tabName).classList.add('active');
                button.classList.add('active');
            });
        });

        // Tree functionality
        document.querySelectorAll('.tree-item.is-folder .toggle').forEach(toggle => {
            const parentItem = toggle.closest('.tree-item');
            if (parentItem) {
                toggle.addEventListener('click', () => parentItem.classList.toggle('is-open'));
            }
        });

        const allFolders = document.querySelectorAll('.tree-item.is-folder');

        const expandBtn = document.getElementById('expand-all-btn');
        const collapseBtn = document.getElementById('collapse-all-btn');

        if (expandBtn) {
            expandBtn.addEventListener('click', () => {
                allFolders.forEach(folder => {
                    folder.classList.add('is-open');
                });
            });
        }

        if (collapseBtn) {
            collapseBtn.addEventListener('click', () => {
                allFolders.forEach(folder => {
                    folder.classList.remove('is-open');
                });
            });
        }
    });
</script>
{% endblock %}
